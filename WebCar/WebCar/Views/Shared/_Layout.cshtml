@using System.Web.Security
@using System.Web

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>@ViewBag.Title - VinFast CarSale</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="~/Content/CSS/layout-modern.css" rel="stylesheet" />
    <link href="~/Content/CSS/index.css" rel="stylesheet" />

    @RenderSection("styles", required: false)
</head>
<body>

    <!-- ========================= NAVBAR WITH CENTER MENU ========================= -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container-fluid px-4">

            <!-- Logo -->
            <a class="navbar-brand" href="@Url.Action("Index", "Home")">
                <img src="~/images/logo.png" class="logo-highlight" alt="VinFast" height="45">
            </a>

            <!-- Mobile toggle -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Menu -->
            <div class="collapse navbar-collapse" id="navbarContent">

                <!-- ✅ CENTER MENU -->
                <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="@Url.Action("Index", "Home")">
                            <i class="fas fa-home me-1"></i>
                            <span>Trang chủ</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="@Url.Action("About", "Home")">
                            <i class="fas fa-info-circle me-1"></i>
                            <span>Giới thiệu</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="@Url.Action("Index", "Product")">
                            <i class="fas fa-car me-1"></i>
                            <span>Ô tô</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="@Url.Action("Energy", "Home")">
                            <i class="fas fa-charging-station me-1"></i>
                            <span>Pin & Trạm sạc</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="@Url.Action("LuuTruNL", "Home")">
                            <i class="fas fa-battery-full me-1"></i>
                            <span>Lưu trữ năng lượng</span>
                        </a>
                    </li>

                    <!-- ✅ Role-based Menu cho ADMIN/MANAGER -->
                    @if (User.Identity.IsAuthenticated && Session["CustomerName"] != null)
                    {
                        var userRole = Session["RoleName"]?.ToString() ?? "CUSTOMER";

                        if (userRole == "ADMIN")
                        {
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                                    <i class="fas fa-shield-alt me-1"></i>
                                    <span>Quản trị</span>
                                </a>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="@Url.Action("Index", "Admin")">
                                            <i class="fas fa-tachometer-alt"></i> Dashboard
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="@Url.Action("Users", "Admin")">
                                            <i class="fas fa-users"></i> Người dùng
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="@Url.Action("Create", "Product")">
                                            <i class="fas fa-plus-circle"></i> Thêm xe mới
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider" /></li>
                                    <li>
                                        <a class="dropdown-item" href="@Url.Action("Index", "Audit")">
                                            <i class="fas fa-history"></i> Audit Logs
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        }

                        if (userRole == "ADMIN" || userRole == "MANAGER")
                        {
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                                    <i class="fas fa-chart-line me-1"></i>
                                    <span>Báo cáo</span>
                                </a>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="@Url.Action("Dashboard", "Audit")">
                                            <i class="fas fa-chart-bar"></i> Dashboard
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="@Url.Action("SecurityEvents", "Audit")">
                                            <i class="fas fa-exclamation-triangle"></i> Sự kiện bảo mật
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        }

                        <!-- Menu cho TẤT CẢ user đã đăng nhập -->
                        <li class="nav-item">
                            <a class="nav-link" href="@Url.Action("MyOrders", "Order")">
                                <i class="fas fa-shopping-bag me-1"></i>
                                <span>Đơn hàng</span>
                            </a>
                        </li>
                    }
                </ul>

                <!-- ✅ RIGHT MENU - Login/User -->
                <ul class="navbar-nav ms-auto align-items-lg-center">
                    @if (!User.Identity.IsAuthenticated || Session["CustomerName"] == null)
                    {
                        <!-- Chưa đăng nhập -->
                        <li class="nav-item me-2">
                            <a class="btn btn-outline-primary btn-sm" href="@Url.Action("Login", "Account")">
                                <i class="fas fa-sign-in-alt me-1"></i>
                                <span>Đăng nhập</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="btn btn-primary btn-sm" href="@Url.Action("Register", "Account")">
                                <i class="fas fa-user-plus me-1"></i>
                                <span>Đăng ký</span>
                            </a>
                        </li>
                    }
                    else
                    {
                        string customerName = Session["CustomerName"]?.ToString() ?? "User";
                        string displayName = customerName.Length > 15 ? customerName.Substring(0, 12) + "..." : customerName;
                        string firstLetter = customerName.Substring(0, 1).ToUpper();

                        <!-- User Dropdown -->
                        <li class="nav-item dropdown me-2">
                            <a class="nav-link dropdown-toggle user-dropdown-toggle d-flex align-items-center"
                               href="#"
                               id="userMenu"
                               data-bs-toggle="dropdown">
                                <span class="user-avatar me-2">@firstLetter</span>
                                <span class="user-name-text d-none d-lg-inline">@displayName</span>
                            </a>

                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                                <li>
                                    <!-- ✅ SỬA ĐÂY: Profile → MyProfile -->
                                    <a class="dropdown-item" href="@Url.Action("MyProfile", "Account")">
                                        <i class="fas fa-user"></i>
                                        <span>Thông tin cá nhân</span>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="@Url.Action("MyOrders", "Order")">
                                        <i class="fas fa-shopping-cart"></i>
                                        <span>Đơn hàng của tôi</span>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="@Url.Action("index", "Audit")">
                                        <i class="fas fa-history"></i>
                                        <span>Lịch sử hoạt động</span>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="@Url.Action("ChangePassword", "Account")">
                                        <i class="fas fa-key"></i>
                                        <span>Đổi mật khẩu</span>
                                    </a>
                                </li>

                                <li><hr class="dropdown-divider" /></li>

                                <li>
                                    @using (Html.BeginForm("Logout", "Account", FormMethod.Post, new { id = "logoutForm", style = "margin: 0; padding: 0;" }))
                                    {
                                        @Html.AntiForgeryToken()
                                        <button class="dropdown-item text-danger" type="submit">
                                            <i class="fas fa-sign-out-alt"></i>
                                            <span>Đăng xuất</span>
                                        </button>
                                    }
                                </li>
                            </ul>
                        </li>

                        <li class="nav-item">
                            <a class="btn btn-primary btn-sm" href="@Url.Action("Index", "Product")">
                                <i class="fas fa-hand-holding-usd me-1"></i>
                                <span>Đặt cọc</span>
                            </a>
                        </li>
                    }
                </ul>
            </div>

        </div>
    </nav>
    <!-- ========================= END NAVBAR ========================= -->
    <!-- Main Content -->
    <div class="body-content">
        <!-- Alert Messages -->
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="container mt-5 pt-5">
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="container mt-5 pt-5">
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle"></i> @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        }

        @RenderBody()
    </div>

    <!-- Scroll to Top Button -->
    <div class="scroll-to-top" id="scrollToTop">
        <i class="fas fa-arrow-up"></i>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container2">
            <div class="footer-section">
                <img src="~/images/logo.png" alt="VinFast Logo" class="logo-footer" />
                <h5>VinFast Auto</h5>
                <p><strong>Công ty TNHH Kinh doanh Thương mại và Dịch vụ VinFast</strong></p>
                <p><strong>MST/MSDN:</strong> 0123344555</p>
                <p><strong>Địa chỉ:</strong> Số 7, Phường Tân Thuận Đông, Quận 7, TP.HCM</p>
            </div>

            <div class="footer-section">
                <h5>Về VinFast</h5>
                <ul class="footer-links">
                    <li><a href="@Url.Action("About", "Home")">Giới thiệu công ty</a></li>
                    <li><a href="#">Tin tức & Sự kiện</a></li>
                    <li><a href="#">Tuyển dụng</a></li>
                    <li><a href="#">Liên hệ</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h5>Hỗ trợ khách hàng</h5>
                <ul class="footer-links">
                    <li><a href="#">Chính sách bảo hành</a></li>
                    <li><a href="#">Chính sách đổi trả</a></li>
                    <li><a href="#">Hướng dẫn mua xe</a></li>
                    <li><a href="#">Câu hỏi thường gặp</a></li>
                </ul>
            </div>

            <div class="footer-section footer-contact">
                <h5>Liên hệ</h5>
                <p><i class="fas fa-phone-alt me-2"></i> <strong>Hotline:</strong> 1900 23 23 89</p>
                <p><i class="fas fa-envelope me-2"></i> <strong>Email:</strong> support.vn@vinfastauto.com</p>
                <div class="footer-social mt-3">
                    <a href="#" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" title="YouTube"><i class="fab fa-youtube"></i></a>
                    <a href="#" title="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="#" title="Twitter"><i class="fab fa-twitter"></i></a>
                </div>
            </div>
        </div>

        <div class="text-center mt-4 pt-3" style="border-top: 1px solid rgba(255,255,255,0.1);">
            <p class="mb-0" style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                &copy; @DateTime.Now.Year VinFast. All rights reserved.
            </p>
        </div>
    </footer>

    <!-- Chat Assistant -->
    <div class="chat-assistant">
        <div class="chat-button" onclick="toggleChat()">
            <i class="fas fa-comments"></i>
            <i class="fas fa-times"></i>
            <span class="chat-badge">1</span>
        </div>

        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <div class="chat-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="chat-info">
                    <h6>VinFast Assistant</h6>
                    <p>Luôn sẵn sàng hỗ trợ bạn</p>
                </div>
            </div>

            <div class="chat-body" id="chatBody">
                <div class="chat-message bot">
                    <div class="chat-message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="chat-message-content">
                        Xin chào! 👋 Tôi là trợ lý ảo của VinFast. Tôi có thể giúp gì cho bạn?
                    </div>
                </div>

                <div class="chat-quick-replies">
                    <button class="quick-reply-btn" onclick="sendQuickReply('Xem ưu đãi')">
                        🎁 Xem ưu đãi
                    </button>
                    <button class="quick-reply-btn" onclick="sendQuickReply('Tư vấn xe')">
                        🚗 Tư vấn xe
                    </button>
                    <button class="quick-reply-btn" onclick="sendQuickReply('Đặt lịch lái thử')">
                        📅 Đặt lịch lái thử
                    </button>
                    <button class="quick-reply-btn" onclick="sendQuickReply('Liên hệ')">
                        📞 Liên hệ
                    </button>
                </div>
            </div>

            <div class="chat-footer">
                <div class="chat-input-group">
                    <input type="text"
                           class="chat-input"
                           placeholder="Nhập tin nhắn..."
                           id="chatInput"
                           onkeypress="handleChatKeypress(event)">
                    <button class="chat-send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // Navbar scroll
    $(window).scroll(function () {
        if ($(this).scrollTop() > 50) {
            $('.navbar').addClass('scrolled');
            $('#scrollToTop').addClass('show');
        } else {
            $('.navbar').removeClass('scrolled');
            $('#scrollToTop').removeClass('show');
        }
    });

    $('#scrollToTop').click(function () {
        $('html, body').animate({ scrollTop: 0 }, 600);
    });

    // Chat functions
    function toggleChat() {
        $('#chatWindow').toggleClass('show');
        $('.chat-button').toggleClass('active');
        $('.chat-badge').fadeOut();
        $('#chatInput').focus();
    }

    function sendMessage() {
        const input = $('#chatInput');
        const message = input.val().trim();
        if (message) {
            addMessage(message, 'user');
            input.val('');
            setTimeout(() => {
                addMessage(getBotResponse(message), 'bot');
            }, 1000);
        }
    }

    function sendQuickReply(message) {
        addMessage(message, 'user');
        setTimeout(() => {
            addMessage(getBotResponse(message), 'bot');
        }, 1000);
    }

    function addMessage(text, sender) {
        const avatar = sender === 'bot'
            ? '<i class="fas fa-robot"></i>'
            : '<i class="fas fa-user"></i>';

        const html = `
            <div class="chat-message ${sender}">
                <div class="chat-message-avatar">${avatar}</div>
                <div class="chat-message-content">${text}</div>
            </div>
        `;

        $('#chatBody').append(html);
        $('#chatBody').scrollTop($('#chatBody')[0].scrollHeight);
    }

    function getBotResponse(message) {
        const lower = message.toLowerCase();

        if (lower.includes('ưu đãi') || lower.includes('khuyến mãi')) {
            return '🎁 <strong>Ưu đãi đặc biệt tháng này:</strong><br>' +
                   '• Giảm <strong>20%</strong> giá xe<br>' +
                   '• Tặng gói bảo hiểm <strong>1 năm</strong><br>' +
                   '• Miễn phí phụ kiện <strong>10 triệu</strong><br>' +
                   '<a href="@Url.Action("Index", "Product")">Xem chi tiết →</a>';
        }

        if (lower.includes('tư vấn') || lower.includes('xe')) {
            return '🚗 Chúng tôi có nhiều dòng xe phù hợp:<br>' +
                   '• VF 3, VF 5, VF 8, VF 9<br>' +
                   '<a href="@Url.Action("Index", "Product")">Xem tất cả →</a>';
        }

        if (lower.includes('liên hệ') || lower.includes('hotline')) {
            return '📞 <strong>Liên hệ:</strong><br>' +
                   '• Hotline: <strong>1900 23 23 89</strong><br>' +
                   '• Email: support.vn@vinfastauto.com';
        }

        return 'Cảm ơn bạn! Để được hỗ trợ tốt nhất, vui lòng gọi:<br>' +
               '☎️ Hotline: <strong>1900 23 23 89</strong>';
    }

    function handleChatKeypress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    $(document).ready(function () {
        console.log('✅ VinFast Layout loaded!');

        setTimeout(function () {
            $('.alert').fadeOut('slow');
        }, 5000);

        setTimeout(function () {
            $('.chat-badge').addClass('show');
        }, 3000);
    });
    </script>

    @RenderSection("scripts", required: false)

</body>
</html>