

@model WebCar.Models.ViewModels.ChangePasswordViewModel

@{
    ViewBag.Title = "Đổi mật khẩu";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section class="change-password-section py-5" style="min-height: 80vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <div class="card shadow-lg border-0">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <div class="icon-circle mx-auto mb-3">
                                <i class="fas fa-key fa-3x text-primary"></i>
                            </div>
                            <h2 class="fw-bold text-primary">Đổi mật khẩu</h2>
                            <p class="text-muted">Cập nhật mật khẩu mới cho tài khoản của bạn</p>
                        </div>

                        @using (Html.BeginForm("ChangePassword", "Account", FormMethod.Post, new { @class = "needs-validation" }))
                        {
                            @Html.AntiForgeryToken()

                            @* Display validation summary *@
                            if (!ViewData.ModelState.IsValid)
                            {
                                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                    @Html.ValidationSummary(false, "", new { @class = "mb-0" })
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            }

                            @* Mật khẩu cũ *@
                            <div class="mb-3">
                                @Html.LabelFor(m => m.OldPassword, new { @class = "form-label fw-bold" })
                                <div class="input-group">
                                    <span class="input-group-text bg-light">
                                        <i class="fas fa-lock text-primary"></i>
                                    </span>
                                    @Html.PasswordFor(m => m.OldPassword, new
                                    {
                                        @class = "form-control",
                                        placeholder = "Nhập mật khẩu hiện tại",
                                        required = "required",
                                        id = "OldPassword"
                                    })
                                    <button class="btn btn-outline-secondary" type="button" id="toggleOldPassword">
                                        <i class="fas fa-eye" id="eyeIcon1"></i>
                                    </button>
                                </div>
                                @Html.ValidationMessageFor(m => m.OldPassword, "", new { @class = "text-danger small d-block mt-1" })
                            </div>

                            @* Mật khẩu mới *@
                            <div class="mb-3">
                                @Html.LabelFor(m => m.NewPassword, new { @class = "form-label fw-bold" })
                                <div class="input-group">
                                    <span class="input-group-text bg-light">
                                        <i class="fas fa-key text-primary"></i>
                                    </span>
                                    @Html.PasswordFor(m => m.NewPassword, new
                                    {
                                        @class = "form-control",
                                        placeholder = "Nhập mật khẩu mới (tối thiểu 6 ký tự)",
                                        required = "required",
                                        id = "NewPassword"
                                    })
                                    <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                        <i class="fas fa-eye" id="eyeIcon2"></i>
                                    </button>
                                </div>
                                @Html.ValidationMessageFor(m => m.NewPassword, "", new { @class = "text-danger small d-block mt-1" })

                                @* Password strength indicator *@
                                <div class="mt-2">
                                    <div class="progress" style="height: 5px;">
                                        <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted" id="strengthText"></small>
                                </div>
                            </div>

                            @* Xác nhận mật khẩu mới *@
                            <div class="mb-3">
                                @Html.LabelFor(m => m.ConfirmPassword, new { @class = "form-label fw-bold" })
                                <div class="input-group">
                                    <span class="input-group-text bg-light">
                                        <i class="fas fa-check-circle text-primary"></i>
                                    </span>
                                    @Html.PasswordFor(m => m.ConfirmPassword, new
                                    {
                                        @class = "form-control",
                                        placeholder = "Nhập lại mật khẩu mới",
                                        required = "required",
                                        id = "ConfirmPassword"
                                    })
                                    <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                        <i class="fas fa-eye" id="eyeIcon3"></i>
                                    </button>
                                </div>
                                @Html.ValidationMessageFor(m => m.ConfirmPassword, "", new { @class = "text-danger small d-block mt-1" })

                                @* Match indicator *@
                                <div class="mt-2">
                                    <small id="matchText"></small>
                                </div>
                            </div>

                            @* Password requirements *@
                            <div class="alert alert-info mb-3">
                                <h6 class="alert-heading mb-2">
                                    <i class="fas fa-info-circle me-2"></i>Yêu cầu mật khẩu:
                                </h6>
                                <ul class="mb-0 small">
                                    <li id="req-length">Tối thiểu 6 ký tự</li>
                                    <li id="req-upper">Có chữ hoa (khuyến nghị)</li>
                                    <li id="req-number">Có số (khuyến nghị)</li>
                                    <li id="req-special">Có ký tự đặc biệt (khuyến nghị)</li>
                                </ul>
                            </div>

                            @* Submit buttons *@
                            <div class="d-grid gap-2 mb-3">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save me-2"></i>Đổi mật khẩu
                                </button>
                                <a href="@Url.Action("MyProfile", "Account")" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                                </a>
                            </div>
                        }
                    </div>
                </div>

                @* Security tip *@
                <div class="card border-0 bg-transparent text-white mt-3">
                    <div class="card-body text-center">
                        <i class="fas fa-shield-alt fa-2x mb-2"></i>
                        <p class="mb-0 small">
                            <strong>Mẹo bảo mật:</strong> Sử dụng mật khẩu mạnh với sự kết hợp của chữ hoa, chữ thường, số và ký tự đặc biệt.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script>
        $(document).ready(function () {

            // Toggle password visibility
            $('#toggleOldPassword').click(function () {
                togglePassword('#OldPassword', '#eyeIcon1');
            });

            $('#toggleNewPassword').click(function () {
                togglePassword('#NewPassword', '#eyeIcon2');
            });

            $('#toggleConfirmPassword').click(function () {
                togglePassword('#ConfirmPassword', '#eyeIcon3');
            });

            function togglePassword(fieldId, iconId) {
                const field = $(fieldId);
                const icon = $(iconId);
                const type = field.attr('type') === 'password' ? 'text' : 'password';
                field.attr('type', type);
                icon.toggleClass('fa-eye fa-eye-slash');
            }

            // Password strength checker
            $('#NewPassword').on('keyup', function () {
                const password = $(this).val();
                let strength = 0;

                const hasLength = password.length >= 6;
                const hasUpper = /[A-Z]/.test(password);
                const hasNumber = /[0-9]/.test(password);
                const hasSpecial = /[^a-zA-Z0-9]/.test(password);

                $('#req-length').toggleClass('text-success', hasLength);
                $('#req-upper').toggleClass('text-success', hasUpper);
                $('#req-number').toggleClass('text-success', hasNumber);
                $('#req-special').toggleClass('text-success', hasSpecial);

                if (hasLength) strength += 25;
                if (password.length >= 8) strength += 15;
                if (hasUpper) strength += 20;
                if (/[a-z]/.test(password)) strength += 10;
                if (hasNumber) strength += 15;
                if (hasSpecial) strength += 15;

                const strengthBar = $('#passwordStrength');
                const strengthText = $('#strengthText');

                strengthBar.css('width', strength + '%');

                if (strength < 40) {
                    strengthBar.attr('class', 'progress-bar bg-danger');
                    strengthText.text('Yếu').css('color', '#dc3545');
                } else if (strength < 70) {
                    strengthBar.attr('class', 'progress-bar bg-warning');
                    strengthText.text('Trung bình').css('color', '#ffc107');
                } else {
                    strengthBar.attr('class', 'progress-bar bg-success');
                    strengthText.text('Mạnh').css('color', '#28a745');
                }

                checkPasswordMatch();
            });

            // Password match checker
            $('#ConfirmPassword').on('keyup', function () {
                checkPasswordMatch();
            });

            function checkPasswordMatch() {
                const newPass = $('#NewPassword').val();
                const confirmPass = $('#ConfirmPassword').val();
                const matchText = $('#matchText');

                if (confirmPass.length === 0) {
                    matchText.text('');
                    return;
                }

                if (newPass === confirmPass) {
                    matchText
                        .html('<i class="fas fa-check-circle text-success"></i> Mật khẩu khớp')
                        .removeClass('text-danger')
                        .addClass('text-success');
                } else {
                    matchText
                        .html('<i class="fas fa-times-circle text-danger"></i> Mật khẩu không khớp')
                        .removeClass('text-success')
                        .addClass('text-danger');
                }
            }

            // Auto-dismiss alerts
            setTimeout(function () {
                $('.alert-danger, .alert-success').fadeOut('slow');
            }, 5000);

            $('#OldPassword').focus();

            $('form').on('submit', function (e) {
                const newPass = $('#NewPassword').val();
                const confirmPass = $('#ConfirmPassword').val();

                if (newPass !== confirmPass) {
                    e.preventDefault();
                    alert('Mật khẩu mới và xác nhận mật khẩu không khớp!');
                    return false;
                }

                if (newPass.length < 6) {
                    e.preventDefault();
                    alert('Mật khẩu phải có tối thiểu 6 ký tự!');
                    return false;
                }
            });
        });
    </script>

    <style>
        .change-password-section {
            display: flex;
            align-items: center;
        }

        .card {
            border-radius: 15px;
            overflow: hidden;
        }

        .icon-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .input-group-text {
            min-width: 45px;
            justify-content: center;
        }

        .btn-lg {
            padding: 12px;
            font-size: 1.1rem;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .progress-bar {
            transition: width 0.3s ease;
        }

        .alert-info ul li {
            color: #6c757d;
            transition: color 0.3s ease;
        }

            .alert-info ul li.text-success {
                color: #28a745 !important;
            }

                .alert-info ul li.text-success::before {
                    content: '✓ ';
                    font-weight: bold;
                }
    </style>
}
